<html>
    <head>
        <script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
		<script type="text/javascript" src="js/md5.js"></script>
		<script type="text/javascript" src="js/lastfm-api.js"></script>

        
        <script type="text/javascript">
			
			var debugLog = function(whatever){
				if(!localStorage['debug_mode'] || localStorage['debug_mode'] == "false") return;
				console.log(whatever);
			};

            function showPageAction(tabID)
            {
                chrome.pageAction.show(tabID);
                return {'message':'showing pageaction icon'};
            }

            function copyLyrics(lyrics)
            {
                var clip = jQuery("#PE-clipboard-temp");
                clip.val(lyrics);
                clip.select();
                document.execCommand("copy");
                return {'status':'true'};
            }

            function stillListeningNotification()
            {
                var notification = webkitNotifications.createNotification(
                    'images/logo-32.png',
                    'Still listening...',
                    'Please wait until music continues...'
                );

                notification.show();
                setTimeout(function(){
                    notification.cancel();
                },(localStorage["notification_timeout"]*1000));

                return {'message':'still-listening'};
            }

            function hideVideoAdNotification()
            {
                var notification = webkitNotifications.createNotification(
                    'images/logo-32.png',
                    'Video Ad Blocked',
                    'Please wait until music continues...'
                );

                notification.show();
                setTimeout(function(){
                    notification.cancel();
                },(localStorage["notification_timeout"]*1000));

                return {'message':'video-ad-hidden'};
            }

            var notification_timeout, notification;
            function showSongChangeNotification(info)
            {
                if (localStorage["player_controls"] != "true")
                {
                    notification = webkitNotifications.createNotification(
                        info.albumArt,
                        info.songName,
                        info.artistName + " (" + info.albumName + ")"
                    );
                } else {
                    //html notifications are the new shit
                    notification = webkitNotifications.createHTMLNotification(
                        'notification.html?'
                        +'albumArt='+info.albumArt
                        +'&artistName='+info.artistName
                        +'&songName='+info.songName
                        +'&albumName='+info.albumName
                        +'&isLiked='+info.isLiked
                    );
                }

                notification.show();

                //dismiss after a few seconds
                notification_timeout = setTimeout(function(){
                    notification.cancel();
                }, (localStorage["notification_timeout"]*1000));

                return {'message':'PE Notification shown'};
            }

            function localStorageSettings()
            {
                var settings = {
                    selectable_lyrics:				localStorage["selectable_lyrics"],
                    remove_ads:						localStorage["remove_ads"],
                    remove_promobox:				localStorage["remove_promobox"],
                    remove_videos:					localStorage["remove_videos"],
                    remove_tooltips:				localStorage["remove_tooltips"],
                    remove_still_listening:         localStorage["remove_still_listening"],
					remove_ribbon:					localStorage["remove_ribbon"],
                    notification_timeout:           localStorage["notification_timeout"],
                    notification_song_change:       localStorage["notification_song_change"],
                    notification_video_ad:          localStorage["notification_video_ad"],
                    notification_still_listening:   localStorage["notification_still_listening"],
					header_config:					localStorage["header_config"],
                    player_controls:                localStorage["player_controls"],
                    debug_mode:						localStorage["debug_mode"],
					scrobble_session_key:			localStorage["scrobble_session_key"],
					scrobble_session_name:			localStorage["scrobble_session_name"]
                };
                
                return {'message': settings};
            }
            
            var tabID, currentURL;
            function refreshPandora()
            {
                update = {
                    url:        currentURL,
                    selected:   true,
                    pinned:     false
                };
                chrome.tabs.update(tabID, update, function(){});
            }
            
                
            function playerControl(action)
            {
                var control;
                switch (action)
                {
                    case "thumbs_up":
                        control = "thumbs_up";
                        break;
                    case "thumbs_down":
                        control = "thumbs_down";
                        //todo: thumbs down skips song, so it should hide. however, if you're at skip limit, song continues. hmm.
                        //notification.cancel();
                        break;
                    case "play":
                        control = "play";
                        break;
                    case "pause":
                        control = "pause";
                        break;
                    case "skip":
                        control = "skip";
                        break;
                    case "mute":
                        control = "mute";
                        break;
                    case "unmute":
                        control = "unmute";
                        break;
                        
                    default:
                        return false;
                        break;
                }
                
                chrome.tabs.sendRequest(tabID, {
                    'playerControl': control
                }, function(response){});
                
                if (control == "pause"){
                    clearTimeout(notification_timeout);
                }
                
                if (control == "play"){
                    notification_timeout = setTimeout(function(){
                        notification.cancel();
                    }, (localStorage["notification_timeout"]*1000));
                }
            }
            
            function ourWebsites(person)
            {
                if (person == "curt")
                    chrome.tabs.create({url: 'http://curthostetter.com'});
                if (person == "brandon")
                    chrome.tabs.create({url: 'http://brandon-sachs.com'});
                if (person == "twitter")
                    chrome.tabs.create({url: 'http://twitter.com/PandoraEnhancer'});
            }
            

            //message listeners
            chrome.extension.getViews({type:"notification"}).forEach(function(win) {
                win.refreshPandora();
            });
            
            chrome.extension.onRequest.addListener(function(request, sender, sendResponse)
            {
                var notificationType	= request.notificationType;
                var notificationParams	= request.notificationParams;
                var playerControl       = request.playerControl;
                var returnStatus		= false;
                    tabID               = sender.tab.id;
                    currentURL          = sender.tab.url;
                
                if(notificationType == 'getLocalStorage')
                {
                    returnStatus = localStorageSettings();
                }

                if(notificationType == 'showPageAction')
                {
                    returnStatus = showPageAction(sender.tab.id);
                }

                if(notificationType == 'stillListening')
                {
                    returnStatus = stillListeningNotification();
                }

                if(notificationType == 'hideVideoAd')
                {
                    returnStatus = hideVideoAdNotification();
                }

                if(notificationType == 'songChange')
                {
                    returnStatus = showSongChangeNotification({
                        albumArt:   notificationParams.albumArt,
                        artistName: notificationParams.artistName,
                        songName:   notificationParams.songName,
                        albumName:  notificationParams.albumName,
                        isLiked:    notificationParams.isLiked
                    });

					if(localStorage["scrobble_session_key"] && localStorage["scrobble_session_key"] != 'null')
					{
						var dateNow = new Date();
						var timestamp = Math.round(dateNow.getTime()/1000);
						responseDispatcher('scrobble',{
							artistName:		notificationParams.artistName,
							songName:		notificationParams.songName,
							albumName:		notificationParams.albumName,
							timestamp:		timestamp,
							elapsedTime:	notificationParams.elapsedTime
						});
					}

                }

                if(!request.notificationType)
                {
                    if(request.showPageAction)
                    {
                        returnStatus = showPageAction(sender.tab.id);
                    }

					if(request.copyLyrics)
					{
						returnStatus = copyLyrics(request.lyricText);
					}
                    
                    if (request.showSettings)
                    {
                        chrome.tabs.create({url:chrome.extension.getURL('settings.html')});
                    }
                }

                sendResponse(returnStatus);
            });
        </script>
    </head>

    <body>
        <textarea id="PE-clipboard-temp"></textarea>
    </body>
</html>
