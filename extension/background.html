<html>
    <head>
        <script src="js/jquery-1.6.4.min.js"></script>
        <script type="text/javascript">
            function showPageAction(tabID)
            {
                chrome.pageAction.show(tabID);
                return {'message':'showing pageaction icon'};
            }

            function copyLyrics(lyrics)
            {
                var clip = jQuery("#PE-clipboard-temp");
                clip.val(lyrics);
                clip.select();
                document.execCommand("copy");
                return {'status':'true'};
            }

            function stillListeningNotification()
            {
                var notification = webkitNotifications.createNotification(
                    'images/logo-32.png',
                    'Still listening...',
                    'Please wait until music continues...'
                );

                notification.show();
                setTimeout(function(){
                    notification.cancel();
                },(localStorage["notification_timeout"]*1000));

                return {'message':'still-listening'};
            }

            function hideVideoAdNotification()
            {
                var notification = webkitNotifications.createNotification(
                    'images/logo-32.png',
                    'Video Ad Blocked',
                    'Please wait until music continues...'
                );

                notification.show();
                setTimeout(function(){
                    notification.cancel();
                },(localStorage["notification_timeout"]*1000));

                return {'message':'video-ad-hidden'};
            }

            function showSongChangeNotification(info)
            {
                //standard notifications can only have 2 lines of text-only content.
                var notification = webkitNotifications.createNotification(
                    info.albumArt,
                    info.songName,
                    info.artistName + " (" + info.albumName + ")"
                );

                /*
                //html notifications are the new shit
                var notification = webkitNotifications.createHTMLNotification(
                'notification.html?'
                +'albumArt='+info.albumArt
                +'&artistName='+info.artistName
                +'&songName='+info.songName
                +'&albumName='+info.albumName
                );
                */

                notification.show();

                //dismiss after a few seconds
                setTimeout(function(){
                    notification.cancel();
                }, (localStorage["notification_timeout"]*1000)); //can make this a setting, choose how long you want the notification to stay

                return {'message':'PE Notification shown'};
            }

            function localStorageSettings()
            {
                var settings = {
                    selectable_lyrics:				localStorage["selectable_lyrics"],
                    remove_ads:						localStorage["remove_ads"],
                    remove_promobox:				localStorage["remove_promobox"],
                    remove_videos:					localStorage["remove_videos"],
                    remove_tooltips:				localStorage["remove_tooltips"],
                    remove_still_listening:         localStorage["remove_still_listening"],
					remove_ribbon:					localStorage["remove_ribbon"],
                    notification_timeout:           localStorage["notification_timeout"],
                    notification_song_change:       localStorage["notification_song_change"],
                    notification_video_ad:          localStorage["notification_video_ad"],
                    notification_still_listening:   localStorage["notification_still_listening"],
					header_config:					localStorage["header_config"],
                    debug_mode:						localStorage["debug_mode"]
                };
                
                return {'message': settings};
            }
            
            var tabID, currentURL;
            function refreshPandora(){
                update = {
                    url:        currentURL,
                    selected:   true,
                    pinned:     false
                };
                chrome.tabs.update(tabID, update, function(){});
            }

            //message listeners
            chrome.extension.getViews({type:"notification"}).forEach(function(win) {
                win.refreshPandora();
            });
            
            chrome.extension.onRequest.addListener(function(request, sender, sendResponse)
            {
                var notificationType	= request.notificationType;
                var notificationParams	= request.notificationParams;
                var playerControl       = request.playerControl;
                var returnStatus		= false;
                    tabID               = sender.tab.id;
                    currentURL          = sender.tab.url;
                    
                if(playerControl == "mute")
                {
                    //should have a toggle. store previous volume level first.
                    mute = {
                        code: "window.location = 'http://www.pandora.com/#/volume/0'"
                    }                    
                    
                    //added permissions in manifest. eh...
                    chrome.tabs.executeScript(tabID, mute, function(){
                        console.log("muted without page refresh hopefully");
                    });
                }
                
                if(playerControl == "thumbs_up")
                {
                    
                }
                
                if(playerControl == "thumbs_down")
                {
                    
                }
                
                if(playerControl == "skip")
                {
                    
                }
                

                if(notificationType == 'getLocalStorage')
                {
                    returnStatus = localStorageSettings();
                }

                if(notificationType == 'showPageAction')
                {
                    returnStatus = showPageAction(sender.tab.id);
                }

                if(notificationType == 'stillListening')
                {
                    returnStatus = stillListeningNotification();
                }

                if(notificationType == 'hideVideoAd')
                {
                    returnStatus = hideVideoAdNotification();
                }

                if(notificationType == 'songChange')
                    {
                    returnStatus = showSongChangeNotification({
                        albumArt:   notificationParams.albumArt,
                        artistName: notificationParams.artistName,
                        songName:   notificationParams.songName,
                        albumName:  notificationParams.albumName
                    });
                }

                if(!request.notificationType)
                {
                    if(request.showPageAction)
                    {
                        returnStatus = showPageAction(sender.tab.id);
                    }

					if(request.copyLyrics)
					{
						returnStatus = copyLyrics(request.lyricText);
					}
                    
                    if (request.showSettings)
                    {
                        chrome.tabs.create({url:chrome.extension.getURL('settings.html')});
                    }
                }

                sendResponse(returnStatus);
            });
        </script>
    </head>

    <body>
        <textarea id="PE-clipboard-temp"></textarea>
    </body>
</html>